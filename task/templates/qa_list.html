<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Answer Questions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Combo&family=Lobster&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/static/custom_styles.css">
</head>

<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="search-results">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="answerModal" tabindex="-1" aria-labelledby="answerModalLabel" aria-hidden="true">

  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>


      <form id="answerForm">
        <div class="mb-3">
          <label for="answer" class="form-label">Your Reply:</label>
          <textarea class="form-control" id="answer" rows="3"></textarea>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">OK</button>
      </form>
    </div>
  </div>
</div>
</div>


<div class="container-fluid">
  <div class="row">
    <div class="col-12 fixed-top bg-light">
      <div class="top-bar d-flex justify-content-between align-items-center p-2">

        <div class="col-md-4">
          <input class="form-control me-2" type="search" placeholder="Search" id="searchInput">
        </div>

        <div class="col-md-8">
          <div class="title">Question List</div>
        </div>
        
      </div>
    </div>
  </div>
</div>



<div class="row">
  <div class="col-md-3">
    <div class="sidebar sticky-top">
      <br>
      <br>
      <div id="sidebar_home"><a href="{{ url_for('task.index_page') }}">Home</a></div>
      <br>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('user.profile', id=current_user.id) }}"><img
          src="{{ url_for('static', filename='profile_icon.png') }}" alt="Profile"> Profile</a>
      <br>
      <a href="{{ url_for('task.accept') }}"><img src="{{ url_for('static', filename='accept_task_icon.png') }}"
          alt="Accept Task"> Answer Question</a>
      <br>
      <a href="{{ url_for('task.post') }}"><img src="{{ url_for('static', filename='post_task_icon.png') }}"
          alt="Post Task"> Post Question</a>
      <br>
      <a id="logout-link" href="{{ url_for('user.logout') }}">
        <img src="{{ url_for('static', filename='logout_icon.png') }}" alt="Logout">
        Logout
      </a>
      {% else %}
      <a href="{{ url_for('user.login') }}"><img src="{{ url_for('static', filename='search_icon.png') }}" alt="Login">
        Login</a>
      <br>
      <a href="{{ url_for('user.register') }}"><img src="{{ url_for('static', filename='profile_icon.png') }}"
          alt="Register"> Register</a>
      {% endif %}
      <br>
      <br>
      <p style="text-align: center; font-weight: bold;">v.3.0.1</p>
    </div>
  </div>


  <div class="col-md-9">
    <div class="main sticky-top">
      <div class="main">
        <div class="row">
          <div class="container mt-5">

            <div id="task-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
              {% for task in page_data.items %}
              <div class="col">
                <div class="card h-100">
                  <div class="card-header">{{ task.title }}</div>
                  <div class="card-body">
                    <p class="card-text mb-2">{{ task.content|safe|truncate(200) }}<a class="stretched-link"
                        href="/detail/9">View Details</a></p><span class="badge bg-primary rounded-pill me-2"></span>
    

                    <button type="button"
                      class="btn btn-outline-primary like-btn" data-task-id="9">üëç <span class="like-count">0</span>
                      Like</button><button type="button" class="btn btn-outline-danger dislike-btn" data-task-id="9">üëé
                      <span class="like-count">0</span> Dislike</button>

                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                      data-bs-target="#addComment{{ task.id }}">Write Answer</button>
                  </div>
                </div>
              </div>
              <!-- Modal for writing an answer -->
              <div class="modal fade" id="addComment{{ task.id }}" tabindex="-1" role="dialog" aria-labelledby="addCommentLabel{{ task.id }}">
                <div class="modal-dialog" role="document">
                    <form method="post" action="{{ url_for('task.detail', t_id=task.id) }}">
                        {{ form.csrf_token }}
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addCommentLabel{{ task.id }}">Write Your Answer</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    {{ form.content }}
                                    {{ ckeditor.load() }}
                                    {{ ckeditor.config(name='content') }}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  
</div>


</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(function () {
  // Like button click handler
  $('.like-btn').on('click', function (e) {
    e.preventDefault();
    var $this = $(this);
    var answerId = $this.data('answer-id');
    console.log(answerId);

    $.ajax({
      url: '/answer/like/' + answerId,
      method: 'POST',
      success: function (response) {
        $this.find('.like-count').text(response.like_count);
        $this.addClass('disabled');
        $this.siblings('.btn-outline-danger').removeClass('disabled');
      },
      error: function (xhr) {
        handleAjaxError(xhr);
      }
    });
  });

  // Dislike button click handler
  $('.dislike-btn').on('click', function (e) {
    e.preventDefault();
    var $this = $(this);
    var answerId = $this.data('answer-id');
    console.log(answerId);

    $.ajax({
      url: '/answer/dislike/' + answerId,
      method: 'POST',
      success: function (response) {
        $this.find('.like-count').text(response.dislike_count);
        $this.addClass('disabled');
        $this.siblings('.btn-outline-primary').removeClass('disabled');
        $this.siblings('.btn-outline-primary').find('.like-count').text(response.like_count);
      },
      error: function (xhr) {
        handleAjaxError(xhr);
      }
    });
  });

  // Fetch tasks
  $.ajax({
    url: "/task",
    type: "GET",
    data: { per_page: 5, page: 2 },
    success: function (response) {
      if (response.message === "Success") {
        const tasks = response.data;
        const taskList = $("#task-list");

        tasks.forEach(function (task) {
          const taskCard = $("<div class='col'>");
          const cardBody = $("<div class='card h-100'>");
          const cardHeader = $("<div class='card-header'>").text(task.title);
          const cardContent = $("<div class='card-body'>");
          const taskContent = $("<p class='card-text mb-2'>").html(task.content);
          const taskCategory = $("<span class='badge bg-primary rounded-pill me-2'>").text(task.category);

          const likeButton = $("<button type='button' class='btn btn-outline-primary like-btn'>")
            .html(`üëç <span class="like-count">${task.like_count}</span> Like`)
            .attr("data-task-id", task.id);

          const dislikeButton = $("<button type='button' class='btn btn-outline-danger dislike-btn'>")
            .html(`üëé <span class="like-count">${task.dislike_count}</span> Dislike`)
            .attr("data-task-id", task.id);

          const taskLink = $("<a class='stretched-link' href='/detail/" + task.id + "'>").text("View Details");

          cardContent.append(taskContent, taskCategory, likeButton, dislikeButton, taskLink);
          cardBody.append(cardHeader, cardContent);
          taskCard.append(cardBody);
          taskList.append(taskCard);
        });

        $(".like-btn").on("click", function (e) {
          e.preventDefault();
          const button = $(this);
          const taskId = button.data("task-id");

          $.ajax({
            url: `/task/like/${taskId}`,
            method: "POST",
            success: function (response) {
              button.find(".like-count").text(response.like_count);
              button.addClass("disabled");
              button.siblings(".dislike-btn").removeClass("disabled");
            },
            error: function (xhr) {
              alert("An error occurred while processing your request.");
            }
          });
        });

        $(".dislike-btn").on("click", function (e) {
          e.preventDefault();
          const button = $(this);
          const taskId = button.data("task-id");

          $.ajax({
            url: `/task/dislike/${taskId}`,
            method: "POST",
            success: function (response) {
              button.find(".like-count").text(response.dislike_count);
              button.addClass("disabled");
              button.siblings(".like-btn").removeClass("disabled");
              button.siblings(".like-btn").find(".like-count").text(response.like_count);
            },
            error: function (xhr) {
              alert("An error occurred while processing your request.");
            }
          });
        });
      } else {
        console.error("Error:", response.message);
      }
    },
    error: function (xhr, status, error) {
      console.error("Error:", error);
    }
  });
});



  document.getElementById('searchInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      let query = e.target.value;
      if (query) {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', `/search?query=${encodeURIComponent(query)}`, true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            let searchResults = document.getElementById('search-results');
            if (xhr.status === 200) {
              let data = JSON.parse(xhr.responseText);
              searchResults.innerHTML = '';
              if (data.length === 0) {
                searchResults.innerHTML = "<p>No results found.</p>";
              } else {
                data.forEach(result => {
                  let item = `
                              <div class="result-item">
                                  <h4><a href="#">${result.title}</a></h4>
                                  <p>${result.content}</p>
                              </div>
                          `;
                  searchResults.innerHTML += item;
                });
              }
            } else {
              searchResults.innerHTML = "<p>An error occurred while fetching search results.</p>";
            }
            new bootstrap.Modal(document.getElementById('searchModal')).show();
          }
        };
        xhr.send();
      }
    }
  });


  $(document).ready(function () {

    $('.list-group-item').click(function (e) {
      e.preventDefault();

      // Get task details from data attributes
      var taskId = $(this).data('task-id');
      var taskTitle = $(this).data('task-title');
      var taskContent = $(this).data('task-content');
      var taskTime = $(this).data('task-time');
      var taskImg = $(this).data('task-img');

      // Update the modal with actual task details
      $('#taskTitle').text(taskTitle);
      $('#taskDetail').html(taskContent);
      $('#taskWhen').text(taskTime);

      // Check if there is a task image to show
      if (taskImg) {
        $('#taskPhoto').attr('src', taskImg).show();
      } else {
        $('#taskPhoto').hide(); // Hide the image element if no image is available
      }

      // Show the modal using Bootstrap 5 method
      const myModal = new bootstrap.Modal($('#answerModal'));
      myModal.show();
    });


  });

  </script>
  </body>

</html>